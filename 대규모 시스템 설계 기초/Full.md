# 1장. 사용자 수에 따른 규모확장성

> 수백만 이상의 유저를 감당해 낼 수 있는 시스템의 기초 설계법 설명
>

### DB

- 샤딩
- DB 다중화
- 적절한 DB 활용
- 다양한 데이터 센터 활용

### 캐시

- 가능한 한 많은 캐시 활용

### 독립성과 확장성

- 웹 계층은 무상태 계층으로
- 모든 계층 다중화 설계
- 각 서비스 독립적 운영 - 메시지 큐가 그 일종

### 기타

- (선택적으로 선택 및 적용)로그, 자동화, 매트릭

# 2장. 개략적인 규모 추정

> QPS, 최대 QPS, 저장소 요구량 등에 대한 개략적 추정 방법(과정) 설명
>

Computer Science와 관련된 수치에 대한 연습 필요

# 3장. 시스템 설계 면접 공략법

> 시스템 설계 면접 과정 및 방법 설명
>

서둘러 설계하지 않고 상황에 대해 충분히 가정(요구사항을 정리)하고 진행

면접관과 끊임없이 소통

1. 요구사항 정리 (문제 이해 및 설계 범위 확정)
2. 청사진 그림 (개략적인 설계안 제시 및 동의 구하기)
3. 상세 설계
4. 마무리

# 4장. 처리율 제한 장치 시스템 개발

> 처리율 제한 장치 개발
>
1. 구현 위치
- 애플리케이션(서버)
- 클라이언트(비추천)
- 미들웨어
- 혹은 3번 네트워크 계층
1. 알고리즘
- 버킷
- 윈도우
1. 처리율 규칙 관리 방식
- 문서형
1. 분산 환경에서의 구현
- 레디스 동시성 문제
- db 동기화 문제

# 5장. 안정 해시 설계

안정 해시는 균등한 데이터 분배 유지를 지원하여 수평적 확장을 돕는다.

1. 기존 해시 방식은 키의 재분배 이슈가 있음
2. 디폴트 안정해시 모델은 파티션 분배 및 데이터 균등 분포에 이슈가 잇음
3. 따라서, 안정해시 모델에 노드를 추가하여 균등 분포를 지원함.



# 6장. 키/값 저장소 설계

키/값 저장소 설계. 단일 서버가 아닌 다중 분산처리 저장소로 설계해야 안정성 및 가용성이 보장된다. 다중 분산처리에는 해시기술이 반드시 들어가야 하므로 다중 분산해시 저장소라고도 한다.

파티션 및 다중화 기술이 제일 핵심이며, 이 때 일관성을 보장하기 위해 벡터버져닝, 정족수 합의 등의 기술이 사용된다. 추가적으로 장애처리 및 읽기, 쓰기 연산에 대한 기술들을 설명한다.

cap 중 cp 또는 ap 어떤걸 선택할지도 함께 고민해야 한다.

# 7장. 분산 시스템을 위한 유일 ID 생성기 설계

분산 환경에서는 여러 DB 서버가 있기 때문에 auto_increment가 정상작동하지 않는다.

1. 다중 마스터 복제 - N대의 DB서버 = auto_increment + N ⇒ 시간순 정렬 불가
2. UUID ⇒ 시간순 정렬 불가
3. 티켓서버 - 1대의 마스터DB 사용 ⇒ SPOF
4. 트위터 스노플레이크
   ID를 여러 section으로 나눠 다양한 의미를 가지게 함

# 8장. URL 단축기 설계

개략적 추정 후, Rest API와 리디렉션 그리고, 변환 함수(해시)를 먼저 개략적으로 설계한다. 이후 상세 설계로 넘어와 데이터 구조, 변환 방식(해시 후 충돌 해결 또는 BASE62 사용), 전체적인 구조와 실제 리디렉션 작동 방식(캐시 활용)에 대해서 설명한다.

# 9장. 웹 크롤러 설계

검색엔진 인덱싱, 웹 마이닝 등 다양한 목적으로 웹 크롤링이 수행된다.

웹 크롤링 설계의 가장 중요한 요소

- 규모 확장성
    - 무상태를 통한 수평적 확장성 부여
- 안정성
    - 거미덫은 규칙으로 찾기 힘드므로 모니터링하여 특정 도메인을 예외처리해야한다.
- 예절
    - 라우터를 도입해 특정 도메인에 단기간 너무 많은 요청을 보내지 않도록 한다.
- 확장성
    - 위에서 설명한 각 컴포넌트는 모듈화하여 기능의 추가/삭제가 쉽게 이루어지도록 한다.

위 네 가지 요소를 충분히 고려하여 시스템 설계를 한다.

또한 대용량의 정보를 처리하는 만큼 병목점에 의한 성능 이슈가 발생하기 쉽다. 이 책에서는 도메인IP변환, 다운로드한 웹의 DB저장이 병목점이 될 수 있다고 설명하며 도메인IP 캐싱 및 메모리 버퍼를 이용한 디스크 저장기법에 대해서 얘기한다.

# 10장. 알림 시스템 설계

알림 시스템은 결과물의 종류에 따라 앱푸시/메일/SMS 알림 등으로 나뉘며 각각을 지원하는 써드파티 서비스 또는 클라우드 서비스가 존재.

최초 설계:
알림 발송 클라언이트 → 알림 시스템 → 외부 서비스 → 알림

1차 개선 설계:
알림 발송 클라이언트 → 알림 시스템(캐시와 DB 연동, 수평적 확장 가능하도록) → 메시지 큐 → workers → 외부 서비스 → 알림

2차 개선 설계 - 안정성 및 추가 컴포넌트 고려
알림 발송 클라이언트 → 알림 시스템(캐시와 DB 연동, 수평적 확장 가능하도록, 사용자 인증 및 발신제한 확인, 이벤트 추적) → 메시지 큐(메시지큐 모니터링 통합) → workers(이벤트 추적, 템플릿 및 로그 추가) → 외부 서비스 → 알림(이벤트 추적)

# 11. 뉴스 피드 시스템 설계

매우 유명한 면접 문제. 페이스북 뉴스 피드 설계, 인스타그램 피드 설계, 트위터 타임라인 설계 등이 비슷한 문제이다.

## 1. 문제 이해 및 설계 범위 확정

의도와 필수 기능을 명확히 해야 한다.

- 클라이언트(단말기)
- 주요 기능 → 스토리 업로드 및 스토리 보기. 비디오 포함
- 뉴스 피드 노출 순서
- 친구 수/ DAU

## 2. 개략적 설계안 제시 및 동의 구하기

1) 피드 발행 ⇒ POST v1/me/feed
   포스팅 저장 / 전송 / 알림 서비스

2) 뉴스 피드 생성 ⇒ GET v1/me/feed

## 3. 상세 설계

### 1) 피드 발행

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/5e77bd9c-316a-4e86-8082-6bc082cd2469/dfb82b85-487a-448c-b7a7-96fd9fe07b97/Untitled.png)

- 전송 = 팬아웃은 두 종류가 있음. 장 단이 있으므로 피드 별/유저 별 섞어서 사용해야 함.
1) 쓰기 시점에 팬아웃(fanout-on-write) = push model
2) 읽기 시점에 팬아웃(fanout-on-read) = pull model
- 그래프 데이터베이스 공부

### 2) 뉴스 피드 생성(피드 읽기)

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/5e77bd9c-316a-4e86-8082-6bc082cd2469/6adb0488-67fd-4d80-a526-590dbfc97ca2/Untitled.png)

### * 캐시 구조는 뉴스 피드 시스템의 핵심 컴포넌트

## 4. 마무리

- 메시지 큐를 사용하여 컴포넌트 사이의 결합도 낮추기
  → 피드 발행의 포스팅 저장 서비스, 전송 서비스, 알림 서비스는 메시지 큐를 이용한 이벤트 기반으로 동작해도 되지 않을까…
- 가능한 한 많은 데이터를 캐시할 방법, 핵심 메트릭에 대한 모니터링 등에 대한 고민은 해보는게 좋을 듯.

# 12. 채팅 시스템 설계

## 1. 요구사항 조사

- 그룹/1:1채팅
- 클라이언트 종류(디바이스)
- 트래픽, 그룹크기, 메시지크기, 메시지 저장기간 등
- 추가기능(첨부파일, 이미지 등)
- 종단간 암호화 여부

## 2. 개략적 설계안

- 웹소켓 사용
- 상태유지 / 무상태 / 써드파티로 시스템 분할
- DB 선택(키-밸류)

## 3. 상세 설계

- 서비스(채팅서버) 선택 : 주키퍼
- 메시지 흐름 방식: 1:1 채팅, 그룹 채팅, 단말간 동기화 방식
- 상태 표시: 접속 장애시 등

## 4. 추가 논의사항

- 종단간 암호화
- 최적화: 캐시, 로딩속도
- 추가기능(이미지 등)
- 메시지 오류 처리

(9) 종단간 암호화 기술과 (10) 슬랙에서 사용하는 지역별 네트워크 구축은 추후에 볼 가치가 있어보임. 또한 캐시도 어떻게 할지 고민해보는 연습.

# 13. 검색어 자동 완성 시스템

## 1. 요구사항 분석

- 결과물 개수
- 자동 완성 기준
- 사용자 수
- 자동완성 검색어 위치(시작만 지원 / 중간도 지원)
- 언어

⇒ 고가용성, 고성능(빠른 응답속도), 규모 확장성, 연관성, 정렬

## 2. 개략적 설계안

→ 패스

## 3. 상세 설계안

### 1) 트라이 자료구조

접두어 길이 제한과 인기 검색어 캐싱을 통해 시간복잡도를 O(p) + O(c) + O(clogc) ⇒ O(1)로 개선

### 2) 데이터 수집 서비스

로그 취합을 통한 실시간 수집 / 주기별 수집

쿼리 | 시간(주기별) | 빈도

트라이 자료구조는 문서형DB 또는 해시테이블이 가능

### 3) 질의 서비스

AJAX 요청과 브라우징 캐시(Cache-Control 헤더)를 이용한 최적화

### 4) 트라이 연산

트라이 갱신 방법 : 작을 때는 노드별 갱신, 클 때는 전체 갱신이 효과적

필터 계층을 사용한 부적절한 검색어 제거

### 5) 저장소 규모 확장

단어를 이용한 샤딩 기법. 이 때 샤드 매니저 (Shard Map Manager)를 사용

## 4. 마무리

- 다국어 지원
- 국가별 검색어 상이한 경우
- 실시간 지원

# 14장. 유튜브 설계

= 비디오 플랫폼 설계

## 1. 문제이해 및 설계 범위 확정

- 필수 기능 → 비디오 업로드 및 시청으로 제한
- 클라이언트
- DAU
- 해상도 및 파일 크기
- 클라우드 서비스 활용 여부
- 언어, 기본 이용시간, 암호화 등

## 2. 개략적 설계안

크게 세 가지 컴포넌트로 구성 : CLI, CDN, API서버

![스크린샷 2024-01-14 오전 11.10.57.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/5e77bd9c-316a-4e86-8082-6bc082cd2469/3c2914d9-81e4-45a6-bf74-eb6b9c0f3bfe/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-01-14_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.10.57.png)

업로드 절차 : 동영상 업로드 / 메타데이터 업로드

스트리밍 절차 : CLI → CDN

## 3. 상세 설계

- 비디오 트랜스코딩 → 핵심 기술. 리소스 사용이 큼
- DAG → 추상화를 통한 병렬처리
- 트랜스코딩 아키텍쳐

  ![스크린샷 2024-01-14 오전 11.12.23.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/5e77bd9c-316a-4e86-8082-6bc082cd2469/0eeb3c5a-64cb-4fd9-bdee-aa323f0cc081/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-01-14_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.12.23.png)

- 최적화
    - 병렬 업로드
    - 업로드 시 지역 데이터베이스 사용
    - 메시지 큐를 활용한 아키텍쳐 병렬화
    - 비용 최적화
    - …

## 4. 마무리

- 라이브 스트리밍 방식 고려

# 15장. 구글 드라이브 설계

### 1. 문제 이해 및 설계 범위 확정

- 핵심기능 : 업로드, 다운로드, 동기화, 알림
- DAU : 1000만
- 파일크기제한

외

- 안정성
- 빠른 동기화 속도
- 크지 않은 네트워크 대역폭
- 규모 확장성
- 높은 가용성

## 2. 개략적 설계안 제시 및 동의 구하기

1) 단일서버 설계

2) 클라우드 파일 저장소 사용

클라이언트 → 로드밸런서 → API 서버 → 메타데이터 DB / 파일 저장소(아마존 S3)

3) 최종 설계

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/5e77bd9c-316a-4e86-8082-6bc082cd2469/29ce3f14-779f-44f0-a453-fa68f99e0665/Untitled.png)

## 3. 상세 설계

- 블록 저장소 서버 → 네트워크 대역폭 고려
- 높은 일관성 요구사항 → 메모리 캐싱 시, NoSQL DB는 ACID를 보장하지 않기 때문에 강한 일관성을 보장하기 어려움. 책에서는 RDB를 사용
- 메타데이터 DB
- 업로드 절차
- 다운로드 절차
- 알림 서비스 → 롱폴링
- 저장소 공간 절약 → 중복 제거 및 지능적 백업 전략, 그리고 아카이빙 저장소 사용
- 장애 처리 ⇒ 롱폴링은 유지는 쉽지만 재 생성(복구)는 어렵다!

## 4. 마무리

# 후기

### 2024/01/21 1회 독 후기

책에서 설명하는 기술들을 따라가기도 벅찼기 때문에, 실제로 면접이 어떻게 진행될 지 상상하고 스스로 고민하는 시간이 부족했던 것 같다. 2, 3회독을 추가로 진행하며 실제로 면접을 보는 것 처럼 연습해보면 좋을 것 같다. 또한 각 기술의 상세 내용을 일부 만이라도 훑어보면 좋을 것 같다.